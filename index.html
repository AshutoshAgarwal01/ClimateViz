<html>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<script src="BubbleChart.js"></script>
<script src="LineChart.js"></script>
<link rel="stylesheet" href="slider.css"/>
<link rel="stylesheet" href="style.css"/>

<body onload='init()'>
	<div class="main-container">
		<h1>CS411 - Narrative Visualization.</h1>
		<div id="chart-summary" class="chart-text" style="width:88%">
			<h2 id="chart-title"></h2>
			<p id="chart-desc"></p>
		</div>
		<div>
			<button id="reset-chart" onclick="reset()">Reset</button>
			<button id="back-to-home" onclick="backToHome()">Back</button>
		</div>
		<div id="bubbleChart-outerdiv" class="annotation-text" style="width:100%">
			<div id="bubble-chart-controls" style="width:100%">
				<div class="slider-block" style="width:2%">
					<button id="timer" onclick="startTimer()">Play</button>
				</div>
				<div class="slider-block" style="width:3%">
					<button id="pause-timer" onclick="pauseTimer()">Pause</button>
				</div>
				<div class="slidecontainer" >
					<div class="slider-block" style="width:70%">
						<input id="yearRange"
							type="range" 
							min="1990" 
							max="2019" 
							value="2019" 
							step="1" 
							class="slider"/>
					</div>
					<div id="yearValue" class="slider-label slider-block" style="width:10%"/>
				</div>
				<br><br><br>
				<div>
				<!--Radio Buttons for chart selection-->
					<input type="radio" id="btn-per-capita-co2" name="b_chart" checked="checked" onclick="onBubbleButtonClick(BubbleChartButtonStatus.PerCapita)">
					<label for="btn-per-capita-co2">CO2 Per Capita</label>
				
					<input type="radio" id="btn-total-co2" name="b_chart" onclick="onBubbleButtonClick(BubbleChartButtonStatus.Total)">
					<label for="btn-total-co2">Total CO2</label>
				</div>
			</div>
			
			<div class="chart-legend-container" style="width:100%">
				<div id="bubbleChart-wrapper" class="chart-and-legend-block" style="width:88%">
					<!--<svg id="bubbleChart" width=1400 height=700></svg>-->
				</div>
				<div id="bubbleChart-legend" class="chart-and-legend-block chart-legend" style="width:10%"></div>
			</div>
		</div>
		<div id="lineChart-outerdiv" class="annotation-text" style="100%">
			<div class="chart-legend-container" style="100%">
				<div id="line-chart-wrapper" class="chart-and-legend-block" style="width:88%">
					<div id="line-chart-text" class="chart-text">
						<h2 id="total-emission"></h2>
					</div>
					<!--<svg id="bubbleChart" width=1400 height=700></svg>-->
				</div>
				<div id="lineChart-legend" class="chart-and-legend-block chart-legend" style="width:10%"></div>
			</div>
		</div>
	<div>
<script>
	var fulldata;
	var isPaused = true;
	var bubbleChartButtonStatus = BubbleChartButtonStatus.PerCapita;
	const margin = 50; 
	const outerwidth = 1400 * 0.88; 
	const outerheight = 700; 
	const width = outerwidth - 2 * margin; 
	const height = outerheight - 2 * margin; 
	const incomeGroups = [{name: 'Low income', id: "lowincome"},{name: 'Upper middle income', id: "upmidincome"}, {name: 'Lower middle income', id: "lowmidincome"}, {name: 'High income', id: "highincome"}]
	
	var toolTipTextArray = function(d) {
		return [`${d.Country}`,
				`Year: ${d.Year}`,
				`CO2 emission per capita (metric tons): ${d.PerCapitaCo2}`,
				`Toal CO2 emission (kt): ${d.TotalCO2}`,
				`GDP (Billion dollars): ${d.GDPB}`,
				`Population (Millions): ${d.Population/ 1000000}`];
	}

	// Common tooltip for all charts
	var TooltipText = function(d) {
		let txt = '';
		for (const x of toolTipTextArray(d)) {
			txt = txt === '' ?  x : txt + '\n' + x;
		}	

		return txt;
	}

	// Get selected income groupd
	var getIncomeGroupSelectionStatus = function() {
		let selectionStatus = [];
		for (const incomeGroup of incomeGroups) {
			const groupid = `btn-${incomeGroup.id}`;
			const element = d3.selectAll(`#${groupid}`);
			const isSelected = element === "undefined" ? true : element.attr("selected") === 'true' ? true : false;
			selectionStatus.push({name: incomeGroup.name, selected: isSelected});
		}
		
		return selectionStatus;
	}

	var getSelectedIncomeGroups = function() {
		return getIncomeGroupSelectionStatus().filter(s => s.selected == true).map(m => m.name);
	}

	var resetIncomeGroupSelectionStatus = function() {
		for (const incomeGroup of incomeGroups) {
			const groupid = `btn-${incomeGroup.id}`;
			d3.selectAll(`#${groupid}`).attr("selected", true);;
		}
	}

	// Get time slider value
	var getTimeSliderValue = function() {
		return document.getElementById("yearRange").value;
	}

	// Update bubble charts based on button selection.
	var onBubbleButtonClick = async function(value) {
		bubbleChartButtonStatus = value;
		await updateBubbleChart(getTimeSliderValue());
	}

	// Create grid
	var createGrid = function(xscale, yscale, height, width, margin) {
		return g => g
			.attr("stroke", "currentColor")
			.attr("stroke-opacity", 0.1)
			.call(g => g.append("g")
			  .selectAll("line")
			  .data(xscale.ticks())
			  .join("line")
				.attr("x1", d => margin + xscale(d))
				.attr("x2", d => margin + xscale(d))
				.attr("y1", margin)
				.attr("y2", height + margin))
			.call(g => g.append("g")
			  .selectAll("line")
			  .data(yscale.ticks())
			  .join("line")
				.attr("y1", d => yscale(d) + margin)
				.attr("y2", d => yscale(d) + margin)
				.attr("x1", margin)
				.attr("x2", width + margin));
	}

	// Remove line chart
	async function removeLineChart() {
		d3.select('#lineChart').remove();
		d3.select('#lineChartlegend').remove()
		d3.select("#line-chart-text #total-emission").text("")
	}

	// Update bubble chart when year is changed.
	async function updateBubbleChart(year) {
		removeLineChart();
		removeBubbleChart();
		await bubbleChart(year)
	}

	// Update line chart when country is selected
	async function updateLineChart(d) {
		isPaused = true;
		d3.select("#back-to-home").style("display", "block")
		removeLineChart();
		removeBubbleChart();
		
		d3.select('#bubble-chart-controls').style("display", "none")
		await lineChart(d.Country)
	}

	async function backToHome() {
		removeLineChart();
		removeBubbleChart();
		await init(false);
	}

	async function reset() {
		isPaused = true;
		bubbleChartButtonStatus = BubbleChartButtonStatus.PerCapita;
		resetIncomeGroupSelectionStatus()
		removeLineChart();
		removeBubbleChart();
		d3.select("#btn-per-capita-co2").property("checked", true);
		d3.select("#yearRange").property("value", 2019);
		await init();
	}

	async function pauseTimer() {
		isPaused = true;
	}

	async function startTimer() {
		let func = async function(e) {
		  var slider = document.getElementById("yearRange");
		  slider.value = tyear;
		  
		  if (tyear > 2019 || isPaused == true) {
			timer.stop();
			isPaused = true;
		  }
		  else {
			slider.dispatchEvent(new Event('input'));
			tyear = tyear + 1;
		  }
		}

		var tyear = parseInt(document.getElementById("yearRange").value);
		tyear = tyear == 2019 ? 1990 : tyear + 1;
		if (isPaused == true) {
			isPaused = false;
			var timer = d3.interval(func, 200);
		}
	}

	// Color scale by Income group.
	colors = d3.scaleOrdinal()
		.domain(incomeGroups.map(n => n.name))
		.range(d3.schemeSet2);

	// Circle size by population.
	population2radius = d3.scaleSqrt()
	  .domain([0, 2e9])
	  .range([0, 60])

	async function init(isreset = true) {
		fulldata = await d3.csv("YearCountryWiseIndicators.csv");
		fulldata = fulldata.filter(o => o.Country != 'World');
		d3.select("#back-to-home").style("display", "none")
		var slider = document.getElementById("yearRange");	
		var output = document.getElementById("yearValue");
		output.innerHTML = slider.value;
		
		// Update the current slider value (each time you drag the slider handle)
		slider.oninput = async function() {
			output.innerHTML = this.value;
			await updateBubbleChart(this.value);
		}

		// Create bubble bar chart legend. We can create it here because this will not change durign chart interactions.
		if (isreset){
			removeBubbleChartLegend()
			createBubbleChartLegend(outerheight, incomeGroups, colors, population2radius);
		}
		await bubbleChart(slider.value);
	}
</script>
</body>
</html>